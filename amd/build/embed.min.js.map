{"version":3,"file":"embed.min.js","sources":["../src/embed.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Common values helper for the Moodle tiny_keteditor plugin.\n *\n * @module      tiny_keteditor/embed\n * @copyright   2024 Venkatesan Rangarajan <venkatesanrpu@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {\n    get_string as getString\n}\nfrom 'core/str';\nimport Templates from 'core/templates';\nimport Modal from 'core/modal';\nimport Config from 'core/config';\nimport {\n    exception as displayException\n}\nfrom 'core/notification';\n\nexport const ketcherEmbed = class {\n    editor = null;\n    constructor(editor) {\n        this.editor = editor;\n    }\n    init = async() => {\n        const modal = await Modal.create({\n            title: getString('buttonNameTitle', 'tiny_keteditor'),\n            show: true,\n            removeOnClose: true,\n        });\n        Templates.renderForPromise('tiny_keteditor/ketcher_template', {})\n        .then(async({\n                html,\n                js\n            }) => {\n            Templates.appendNodeContents(modal.getBody(), html, js);\n            const scripturl = new URL(`${Config.wwwroot}/lib/editor/tiny/plugins/keteditor/ketcher/static/js/main.963f80c2.js`);\n            var script = document.createElement('script');\n            script.src = scripturl.toString();\n            document.body.appendChild(script); // Append the script to the body\n            const cssurl = new URL(`${Config.wwwroot}/lib/editor/tiny/plugins/keteditor/ketcher/static/css/main.3fc9c0f8.css`);\n            var link = document.createElement('link');\n            link.href = cssurl.toString();\n            link.rel = 'stylesheet';\n            document.head.appendChild(link); // Append the link to the head\n        })\n        .catch((error) => displayException(error));\n    };\n    waitForKetcher = () => {\n        return new Promise((resolve, reject) => {\n            const checkKetcher = setInterval(() => {\n                if (window.ketcher) {\n                    clearInterval(checkKetcher);\n                    resolve(window.ketcher);\n                }\n            }, 100);\n            setTimeout(() => {\n                clearInterval(checkKetcher);\n                reject(new Error('Ketcher loading timeout'));\n            }, 5000); // Timeout after 5 seconds\n        });\n    };\n};\n\nexport const saveData = async function() {\n    var ketcher = window.ketcher;\n    var struct = await ketcher.getKet();\n    var image = await ketcher.generateImage(struct, {\n        outputFormat: \"svg\",\n        backgroundColor: \"255, 255, 255\"\n    });\n    // Create a new FileReader instance\n    var reader = new FileReader();\n    // Add an event listener for the 'load' event\n    reader.addEventListener('load', function() {\n        // The result attribute contains the data as a Base64 encoded string\n        var base64Image = reader.result;\n\n        // Parse the SVG to get the width and height\n        var parser = new DOMParser();\n        var svgDoc = parser.parseFromString(atob(base64Image.split(',')[1]), \"image/svg+xml\");\n        var svgElement = svgDoc.documentElement;\n        var width = svgElement.getAttribute(\"width\");\n        var height = svgElement.getAttribute(\"height\");\n        if (window.parent.tinyMCE && window.parent.tinyMCE.activeEditor) {\n            var url = URL.createObjectURL(image);\n            var ketString = JSON.stringify(struct);\n            var ketStruct = ketString.replace(/\\\\n/g, '').replace(/\\\\\"/g, '\"').replace(/ /g, '').slice(1, -1);\n            var content = '<img src=\"' + url + '\" width=\"' + width + '\" height=\"' + height + '\">';\n            window.parent.tinyMCE.activeEditor.execCommand('mceInsertContent', 0, content);\n            window.parent.tinyMCE.activeEditor.execCommand('mceInsertContent', 0, '<!--' + ketStruct + '-->');\n        } else {\n            window.console.log('TinyMCE not initialized');\n        }\n        window.parent.document.querySelector(\".modal .close\").click();\n//$(window.parent.document).find(\".modal\").find('.close').click();\n    });\n\n    // Start reading the Blob as a Base64 encoded string\n    reader.readAsDataURL(image);\n};\n"],"names":["editor","constructor","init","async","modal","Modal","create","title","show","removeOnClose","renderForPromise","then","html","js","appendNodeContents","getBody","scripturl","URL","Config","wwwroot","script","document","createElement","src","toString","body","appendChild","cssurl","link","href","rel","head","catch","error","waitForKetcher","Promise","resolve","reject","checkKetcher","setInterval","window","ketcher","clearInterval","setTimeout","Error","struct","getKet","image","generateImage","outputFormat","backgroundColor","reader","FileReader","addEventListener","base64Image","result","svgElement","DOMParser","parseFromString","atob","split","documentElement","width","getAttribute","height","parent","tinyMCE","activeEditor","url","createObjectURL","ketStruct","JSON","stringify","replace","slice","content","execCommand","console","log","querySelector","click","readAsDataURL"],"mappings":";;;;;;;8PAmC4B,MACxBA,OAAS,KACTC,YAAYD,aACHA,OAASA,OAElBE,KAAOC,gBACGC,YAAcC,eAAMC,OAAO,CAC7BC,OAAO,mBAAU,kBAAmB,kBACpCC,MAAM,EACNC,eAAe,uBAETC,iBAAiB,kCAAmC,IAC7DC,MAAKR,MAAAA,WAAMS,KACJA,KADIC,GAEJA,4BAEMC,mBAAmBV,MAAMW,UAAWH,KAAMC,UAC9CG,UAAY,IAAIC,IAAK,GAAEC,gBAAOC,oFAChCC,OAASC,SAASC,cAAc,UACpCF,OAAOG,IAAMP,UAAUQ,WACvBH,SAASI,KAAKC,YAAYN,cACpBO,OAAS,IAAIV,IAAK,GAAEC,gBAAOC,sFAC7BS,KAAOP,SAASC,cAAc,QAClCM,KAAKC,KAAOF,OAAOH,WACnBI,KAAKE,IAAM,aACXT,SAASU,KAAKL,YAAYE,SAE7BI,OAAOC,QAAU,2BAAiBA,UAEvCC,eAAiB,IACN,IAAIC,SAAQ,CAACC,QAASC,gBACnBC,aAAeC,aAAY,KACzBC,OAAOC,UACPC,cAAcJ,cACdF,QAAQI,OAAOC,YAEpB,KACHE,YAAW,KACPD,cAAcJ,cACdD,OAAO,IAAIO,MAAM,8BAClB,2BAKSzC,qBAChBsC,QAAUD,OAAOC,QACjBI,aAAeJ,QAAQK,SACvBC,YAAcN,QAAQO,cAAcH,OAAQ,CAC5CI,aAAc,MACdC,gBAAiB,kBAGjBC,OAAS,IAAIC,WAEjBD,OAAOE,iBAAiB,QAAQ,eAExBC,YAAcH,OAAOI,OAKrBC,YAFS,IAAIC,WACGC,gBAAgBC,KAAKL,YAAYM,MAAM,KAAK,IAAK,iBAC7CC,gBACpBC,MAAQN,WAAWO,aAAa,SAChCC,OAASR,WAAWO,aAAa,aACjCvB,OAAOyB,OAAOC,SAAW1B,OAAOyB,OAAOC,QAAQC,aAAc,KACzDC,IAAMnD,IAAIoD,gBAAgBtB,OAE1BuB,UADYC,KAAKC,UAAU3B,QACL4B,QAAQ,OAAQ,IAAIA,QAAQ,OAAQ,KAAKA,QAAQ,KAAM,IAAIC,MAAM,GAAI,GAC3FC,QAAU,aAAeP,IAAM,YAAcN,MAAQ,aAAeE,OAAS,KACjFxB,OAAOyB,OAAOC,QAAQC,aAAaS,YAAY,mBAAoB,EAAGD,SACtEnC,OAAOyB,OAAOC,QAAQC,aAAaS,YAAY,mBAAoB,EAAG,UAASN,UAAY,eAE3F9B,OAAOqC,QAAQC,IAAI,2BAEvBtC,OAAOyB,OAAO5C,SAAS0D,cAAc,iBAAiBC,WAK1D7B,OAAO8B,cAAclC"}